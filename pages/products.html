<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F8FAFC" />
<title>محصولات | ماهان شاپ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  
  <link rel="stylesheet" href="../assets/css/style.css" />
</head>
<body class="bg-[#F8FAFC] text-gray-900 overflow-x-hidden font-[Vazirmatn] min-h-screen products-page-bg">
  <div id="top" aria-hidden="true"></div>
  
  <!-- هدر اصلی: ناوبری، جستجو و وضعیت ورود کاربر -->
  <div data-include="header"></div>


  <main id="main-content" class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 pt-5 pb-6 md:pb-8">
    <div class="lg:grid lg:grid-cols-12 lg:gap-8">

      <!-- Filter Sidebar -->
      <aside id="filter-sidebar" class="filter-sidebar fixed lg:static top-0 -right-full lg:right-auto w-[86%] sm:w-[78%] md:w-80 max-w-[360px] lg:max-w-none lg:w-full h-full lg:h-auto bg-white lg:bg-transparent z-[160] lg:z-auto lg:col-span-3 lg:block p-4 lg:p-0" role="navigation" aria-label="فیلترهای محصولات">
        <div class="filter-panel bg-white rounded-xl border border-gray-200/80 shadow-sm lg:shadow-lg lg:p-4 flex flex-col">

            <div class="filter-panel-header flex items-center justify-between lg:hidden pb-3 border-b border-gray-200">
                <h2 class="font-bold text-lg text-[#1D1B20]">فیلترها</h2>
                <button id="close-filters-btn" class="p-2 rounded-full hover:bg-gray-100" aria-label="بستن فیلترها" type="button">
                    <span class="material-icon">close</span>
                </button>
            </div>

            <!-- Search in filters -->
            <div class="p-3 border-b border-gray-200 hidden lg:block filter-search">
              <div class="search-shell relative w-full">
                <input type="search" id="filter-search" placeholder="جستجو در محصولات..." class="search-input text-sm pr-3 pl-10 py-2 w-full">
                <span class="material-icon search-icon absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">search</span>
              </div>
            </div>

            <div class="filter-section overflow-y-auto pr-2 max-h-[calc(100vh-180px)] lg:max-h-[calc(100vh-150px)]">
              <details open class="filter-accordion">
                <summary class="filter-accordion-summary">
                  <span>دسته ها</span>
                  <span class="material-icon">expand_more</span>
                </summary>
                <div class="category-filter-list">
                    <button data-category="all" class="category-filter-btn" type="button">
                      <span class="category-label">تمام محصولات</span>
                    </button>
                    <button data-category="accessory" class="category-filter-btn" type="button">
                      <span class="category-label">اکسسوری</span>
                    </button>
                    <button data-category="case" class="category-filter-btn" type="button">
                      <span class="category-label">قاب گوشی</span>
                    </button>
                    <button data-category="phone" class="category-filter-btn" type="button">
                      <span class="category-label">گوشی هوشمند</span>
                    </button>
                    <button data-category="charger" class="category-filter-btn" type="button">
                      <span class="category-label">شارژ</span>
                    </button>
                    <button data-category="airpod" class="category-filter-btn" type="button">
                      <span class="category-label">کاور ایرپاد</span>
                    </button>
                    <button data-category="glass" class="category-filter-btn" type="button">
                      <span class="category-label">گلس و محافظ</span>
                    </button>
                    <button data-category="gadget" class="category-filter-btn" type="button">
                      <span class="category-label">گجت</span>
                    </button>
                </div>
              </details>

              <details open class="filter-accordion">
                <summary class="filter-accordion-summary">
                  <span>فیلترها</span>
                  <span class="material-icon">expand_more</span>
                </summary>
                <div id="dynamic-filters" class="dynamic-filters"></div>
                <div id="dynamic-filters-empty" class="filter-empty hidden">
                  <p>برای این دسته فیلتر دیگری ثبت نشده است.</p>
                </div>
              </details>

              <div class="filter-in-stock-panel mt-4 flex items-center justify-between gap-3 px-4 py-3 bg-[#F8F8FB] border border-gray-200/80 rounded-2xl shadow-sm" aria-live="polite">
                <p class="text-sm font-semibold text-[#1D1B20] whitespace-nowrap">کالاهای موجود</p>
                <label class="in-stock-toggle-switch" for="in-stock-toggle">
                  <input type="checkbox" id="in-stock-toggle">
                  <span class="toggle-track">
                    <span class="toggle-thumb"></span>
                  </span>
                </label>
              </div>
            </div>

            <div class="filter-actions">
              <div class="pt-3">
                  <button id="reset-filters" class="w-full text-center py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-bold hover:bg-gray-200 transition" type="button" aria-label="حذف تمام فیلترها">
                      حذف فیلترها
                  </button>
              </div>
              <div class="lg:hidden pt-3">
                <div class="flex gap-2">
                  <button id="apply-filters-btn" class="flex-1 py-3 px-4 rounded-xl bg-[#2563EB] text-white font-bold hover:bg-[#1D4ED8] transition" type="button">اعمال فیلترها</button>
                </div>
              </div>
            </div>
        </div>
      </aside>
      
      <!-- Products Grid -->
      <div class="lg:col-span-9 mt-6 lg:mt-0">
        <!-- Header: Sort + Results count -->
        <div class="products-header flex flex-col gap-4 p-4 mb-6 bg-gradient-to-r from-[#DBEAFE]/40 to-[#F8FAFC] rounded-3xl border border-gray-200 shadow-[0_20px_60px_rgba(37,99,235,0.12)]" role="heading" aria-level="2">
            <div class="products-header-main flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
              <div class="products-header-sort flex items-center gap-3 flex-1 min-w-[220px]">
                  <span class="material-icon text-[#2563EB] text-2xl">sort</span>
                  <label for="sort-by" class="font-semibold text-sm text-gray-700">مرتب‌سازی</label>
                  <div class="relative flex-1 sm:flex-none sm:w-56">
                    <select id="sort-by" class="sort-select bg-white border border-gray-200 text-gray-900 text-sm rounded-2xl focus:ring-2 focus:ring-[#2563EB] focus:border-[#2563EB] block w-full pr-3 pl-10 py-2.5 appearance-none shadow-sm hover:shadow-md transition">
                        <option value="newest">جدیدترین</option>
                        <option value="oldest">قدیمی‌ترین</option>
                        <option value="price-asc">قیمت: از کم به زیاد</option>
                        <option value="price-desc">قیمت: از زیاد به کم</option>
                    </select>
                    <span class="material-icon absolute left-3 top-1/2 -translate-y-1/2 text-[#2563EB] pointer-events-none text-lg">unfold_more</span>
                  </div>
              </div>
            </div>
            <div class="filters-toolbar flex flex-col gap-3">
              <div class="filters-toolbar-row flex flex-wrap gap-3 items-center justify-between">
                <div class="filters-toolbar-chips flex flex-wrap justify-end gap-2">
                  <div id="selected-filters" class="selected-filters" style="display:none;" aria-live="polite"></div>
                </div>
                <button id="mobile-filter-btn" class="filters-open-btn lg:hidden w-full justify-center" type="button" aria-label="باز کردن فیلترها" aria-expanded="false" aria-controls="filter-sidebar">
                  <span class="material-icon text-xl font-semibold">tune</span>
                  <span class="text-sm font-bold">فیلترهای پیشرفته</span>
                </button>
              </div>
              <div class="active-category-row flex lg:hidden">
                <div class="active-category-pill rounded-full border border-gray-200 bg-white/80 px-3 py-1 text-xs sm:text-sm flex items-center gap-2 shadow-sm">
                  <span class="material-icon text-[#2563EB] text-base">category</span>
                  <span>دسته انتخاب‌شده:</span>
                  <span id="active-category-name" class="font-bold text-[#1A1441]">تمام محصولات</span>
                </div>
              </div>
            </div>
        </div>

              <div id="products-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 sm:gap-3 md:gap-4 lg:gap-5">
          <!-- Product cards will be dynamically populated/filtered. -->
          <article
            class="product-card product-card--hero has-flush-media bg-white rounded-3xl p-4 border border-gray-100 group"
            data-category="case"
            data-brand="apple"
            data-model="آیفون ۱۵"
            data-material="silicone"
            data-price="690000"
            data-popular="9"
            data-new="1"
            data-stock="true"
          >
            <div class="relative">
              <div class="product-media product-media--flush rounded-2xl bg-[#F7F5FA] flex items-center justify-center overflow-hidden" data-media-width="900" data-media-height="900">
                <img src="https://placehold.co/900x900/1f2937/FFFFFF?text=Armor+Case" alt="قاب ضدضربه سری Armor" class="w-full h-full object-contain" width="900" height="900" loading="lazy">
              </div>

              <div class="product-card-color-strip" aria-label="رنگ‌های موجود">
                <span class="color-swatch bg-slate-900" data-color-hex="#0f172a" title="مشکی" aria-label="مشکی"></span>
                <span class="color-swatch bg-zinc-400" data-color-hex="#a1a1aa" title="خاکستری" aria-label="خاکستری"></span>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="font-extrabold text-gray-900 text-sm md:text-base leading-tight truncate">قاب ضدضربه سری Armor</h3>
              <p class="text-[11px] md:text-xs text-gray-500 mt-1">برند: Apple</p>
            </div>

            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-[10px] md:text-xs text-gray-400 line-through">۸۵۰,۰۰۰</div>
                <div class="text-base md:text-lg font-black text-[#2563EB] leading-tight">
                  ۶۹۰,۰۰۰ <span class="text-[10px] md:text-xs font-medium text-gray-500">تومان</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button class="nav-icon-btn ripple product-like-btn w-10 h-10 rounded-2xl bg-white border border-gray-100 text-gray-700 flex items-center justify-center hover:bg-[#EFF6FF] transition" type="button" aria-label="افزودن به علاقه‌مندی">
                  <span class="material-icon text-[22px]">favorite_border</span>
                </button>
                <button class="nav-icon-btn ripple product-add-btn w-10 h-10 rounded-2xl bg-[#2563EB] text-white flex items-center justify-center hover:bg-[#1E3A8A] transition shadow-sm" type="button" aria-label="افزودن به سبد خرید">
                  <span class="material-icon text-[22px]">add</span>
                </button>
              </div>
            </div>
          </article>

          <article
            class="product-card product-card--hero has-flush-media bg-white rounded-3xl p-4 border border-gray-100 group"
            data-category="glass"
            data-brand="samsung"
            data-model="S23"
            data-type="privacy"
            data-price="390000"
            data-popular="8"
            data-new="0"
            data-stock="true"
          >
            <div class="relative">
              <div class="product-media product-media--flush rounded-2xl bg-[#F7F5FA] flex items-center justify-center overflow-hidden" data-media-width="900" data-media-height="900">
                <img src="https://placehold.co/900x900/0ea5e9/FFFFFF?text=Privacy+Glass" alt="گلس پرایوسی S23" class="w-full h-full object-contain" width="900" height="900" loading="lazy">
              </div>

              <div class="product-card-color-strip" aria-label="برچسب محصول">
                <span class="color-swatch bg-sky-500" title="پرایوسی" aria-label="پرایوسی"></span>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="font-extrabold text-gray-900 text-sm md:text-base leading-tight truncate">گلس پرایوسی S23</h3>
              <p class="text-[11px] md:text-xs text-gray-500 mt-1">برند: Samsung</p>
            </div>

            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-base md:text-lg font-black text-[#2563EB] leading-tight">
                  ۳۹۰,۰۰۰ <span class="text-[10px] md:text-xs font-medium text-gray-500">تومان</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button class="nav-icon-btn ripple product-like-btn w-10 h-10 rounded-2xl bg-white border border-gray-100 text-gray-700 flex items-center justify-center hover:bg-[#EFF6FF] transition" type="button" aria-label="افزودن به علاقه‌مندی">
                  <span class="material-icon text-[22px]">favorite_border</span>
                </button>
                <button class="nav-icon-btn ripple product-add-btn w-10 h-10 rounded-2xl bg-[#2563EB] text-white flex items-center justify-center hover:bg-[#1E3A8A] transition shadow-sm" type="button" aria-label="افزودن به سبد خرید">
                  <span class="material-icon text-[22px]">add</span>
                </button>
              </div>
            </div>
          </article>

          <article
            class="product-card product-card--hero has-flush-media bg-white rounded-3xl p-4 border border-gray-100 group"
            data-category="charger"
            data-brand="anker"
            data-type="adapter"
            data-watt="30w"
            data-port="usb-c"
            data-price="980000"
            data-popular="7"
            data-new="0"
            data-stock="true"
          >
            <div class="relative">
              <div class="product-media product-media--flush rounded-2xl bg-[#F7F5FA] flex items-center justify-center overflow-hidden" data-media-width="900" data-media-height="900">
                <img src="https://placehold.co/900x900/f97316/FFFFFF?text=Fast+Charger" alt="شارژر ۳۰ وات Anker" class="w-full h-full object-contain" width="900" height="900" loading="lazy">
              </div>

              <div class="product-card-color-strip" aria-label="ویژگی‌ها">
                <span class="color-swatch bg-orange-500" title="فست شارژ" aria-label="فست شارژ"></span>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="font-extrabold text-gray-900 text-sm md:text-base leading-tight truncate">شارژر ۳۰ وات Anker</h3>
              <p class="text-[11px] md:text-xs text-gray-500 mt-1">برند: Anker</p>
            </div>

            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-base md:text-lg font-black text-[#2563EB] leading-tight">
                  ۹۸۰,۰۰۰ <span class="text-[10px] md:text-xs font-medium text-gray-500">تومان</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button class="nav-icon-btn ripple product-like-btn w-10 h-10 rounded-2xl bg-white border border-gray-100 text-gray-700 flex items-center justify-center hover:bg-[#EFF6FF] transition" type="button" aria-label="افزودن به علاقه‌مندی">
                  <span class="material-icon text-[22px]">favorite_border</span>
                </button>
                <button class="nav-icon-btn ripple product-add-btn w-10 h-10 rounded-2xl bg-[#2563EB] text-white flex items-center justify-center hover:bg-[#1E3A8A] transition shadow-sm" type="button" aria-label="افزودن به سبد خرید">
                  <span class="material-icon text-[22px]">add</span>
                </button>
              </div>
            </div>
          </article>

          <article
            class="product-card product-card--hero has-flush-media bg-white rounded-3xl p-4 border border-gray-100 group"
            data-category="gadget"
            data-brand="baseus"
            data-type="holder"
            data-material="metal"
            data-price="410000"
            data-popular="6"
            data-new="0"
            data-stock="true"
          >
            <div class="relative">
              <div class="product-media product-media--flush rounded-2xl bg-[#F7F5FA] flex items-center justify-center overflow-hidden" data-media-width="900" data-media-height="900">
                <img src="https://placehold.co/900x900/64748b/FFFFFF?text=Car+Holder" alt="هولدر ماشین Baseus" class="w-full h-full object-contain" width="900" height="900" loading="lazy">
              </div>

              <div class="product-card-color-strip" aria-label="رنگ موجود">
                <span class="color-swatch bg-slate-600" title="خاکستری" aria-label="خاکستری"></span>
              </div>
            </div>

            <div class="mt-4">
              <h3 class="font-extrabold text-gray-900 text-sm md:text-base leading-tight truncate">هولدر ماشین Baseus</h3>
              <p class="text-[11px] md:text-xs text-gray-500 mt-1">برند: Baseus</p>
            </div>

            <div class="mt-3 flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-base md:text-lg font-black text-[#2563EB] leading-tight">
                  ۴۱۰,۰۰۰ <span class="text-[10px] md:text-xs font-medium text-gray-500">تومان</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <button class="nav-icon-btn ripple product-like-btn w-10 h-10 rounded-2xl bg-white border border-gray-100 text-gray-700 flex items-center justify-center hover:bg-[#EFF6FF] transition" type="button" aria-label="افزودن به علاقه‌مندی">
                  <span class="material-icon text-[22px]">favorite_border</span>
                </button>
                <button class="nav-icon-btn ripple product-add-btn w-10 h-10 rounded-2xl bg-[#2563EB] text-white flex items-center justify-center hover:bg-[#1E3A8A] transition shadow-sm" type="button" aria-label="افزودن به سبد خرید">
                  <span class="material-icon text-[22px]">add</span>
                </button>
              </div>
            </div>
          </article>
            </div>
        </div>
        <div id="no-results" class="no-results hidden" role="status" aria-live="polite">
            <div class="no-results-card rounded-3xl border border-dashed border-[#BFDBFE]/70 bg-white/90 shadow-lg shadow-blue-50 p-6 text-center">
              <span class="material-icon text-6xl text-[#2563EB] mb-4 inline-block">search_off</span>
              <h3 class="text-xl font-bold text-gray-900 mb-2">محصولی یافت نشد</h3>
              <p class="text-sm text-gray-600 mb-4">فیلترهای خود را بازبینی کنید یا انتخاب دیگری امتحان کنید.</p>
              <div class="flex flex-wrap justify-center gap-3">
                <button id="reset-filters-btn-mobile" class="px-4 py-2 rounded-2xl bg-[#2563EB] text-white text-sm font-bold shadow-md hover:bg-[#1D4ED8] transition">حذف فیلترها</button>
                <a href="../index.html" class="px-4 py-2 rounded-2xl border border-gray-200 text-sm font-semibold text-gray-700 hover:bg-[#EFF6FF] transition">بازگشت به صفحه اصلی</a>
              </div>
            </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Favorites anchor (for footer heart link) -->
  <div id="favorites" aria-hidden="true"></div>
  
  <!-- Mobile Filter Button and Overlay -->
  <div id="filter-overlay" class="filter-overlay" role="presentation"></div>
  
        <script>
    document.addEventListener('DOMContentLoaded', () => {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      const productCards = Array.from(productsGrid.querySelectorAll('.product-card'));      const noResultsEl = document.getElementById('no-results');

      const filterSearch = document.getElementById('filter-search');
      const categoryButtons = document.querySelectorAll('.category-filter-btn');
      const inStockToggle = document.getElementById('in-stock-toggle');
      const selectedFiltersEl = document.getElementById('selected-filters');
      const sortSelect = document.getElementById('sort-by');
      const dynamicFiltersEl = document.getElementById('dynamic-filters');
      const dynamicFiltersEmptyEl = document.getElementById('dynamic-filters-empty');

      const mobileFilterBtn = document.getElementById('mobile-filter-btn');
      const closeFiltersBtn = document.getElementById('close-filters-btn');
      const filterSidebar = document.getElementById('filter-sidebar');
      const filterOverlay = document.getElementById('filter-overlay');
      const resetFiltersBtn = document.getElementById('reset-filters');
      const applyFiltersBtn = document.getElementById('apply-filters-btn');
      const resetFiltersMobileBtn = document.getElementById('reset-filters-btn-mobile');

      const CATEGORY_ALIASES = {
        accessories: 'accessory'
      };

      const activeCategoryNameEl = document.getElementById('active-category-name');
      const updateActiveCategoryLabel = () => {
        if (!activeCategoryNameEl) return;
        const activeBtn = document.querySelector('#filter-sidebar .category-filter-btn.active .category-label');
        const fallback = 'تمام محصولات';
        activeCategoryNameEl.textContent = activeBtn?.textContent?.trim() || fallback;
      };

      const FILTER_GROUPS = {
        all: [
          { key: 'brand', label: 'برند' }
        ],
        accessory: [
          { key: 'brand', label: 'برند' }
        ],
        case: [
          { key: 'brand', label: 'برند گوشی', options: ['apple', 'samsung', 'xiaomi'] },
          { key: 'material', label: 'جنس قاب', options: ['silicone', 'leather', 'clear', 'tpu'] }
        ],
        phone: [
          { key: 'brand', label: 'برند', options: ['apple', 'samsung', 'xiaomi'] },
          { key: 'model', label: 'مدل', options: ['iPhone 15', 'S24', 'Xiaomi 13'] },
          { key: 'storage', label: 'حافظه', options: ['128', '256', '512'] },
          { key: 'ram', label: 'رم', options: ['8', '12', '16'] }
        ],
        charger: [
          { key: 'brand', label: 'برند', options: ['anker', 'apple', 'xiaomi'] },
          { key: 'port', label: 'نوع پورت', options: ['usb-c', 'usb-a', 'usb-c+usb-a'] }
        ],
        airpod: [
          { key: 'brand', label: 'برند', options: ['apple', 'baseus'] },
          { key: 'material', label: 'جنس کاور', options: ['silicone', 'leather', 'hard'] }
        ],
        glass: [
          { key: 'brand', label: 'برند گوشی', options: ['apple', 'samsung', 'xiaomi'] },
          { key: 'model', label: 'مدل گوشی' },
          { key: 'type', label: 'نوع محافظ', options: ['privacy', 'ceramic', 'standard'] }
        ],
        gadget: [
          { key: 'brand', label: 'برند', options: ['baseus', 'ugreen'] },
          { key: 'type', label: 'نوع گجت', options: ['popsocket', 'holder', 'cable'] },
          { key: 'material', label: 'جنس', options: ['plastic', 'metal', 'nylon'] }
        ]
      };

      const FILTER_LABELS = {
        brand: {
          apple: 'اپل',
          samsung: 'سامسونگ',
          xiaomi: 'شیائومی',
          anker: 'Anker',
          baseus: 'Baseus',
          ugreen: 'UGREEN'
        },
        material: {
          silicone: 'سیلیکونی',
          leather: 'چرمی',
          clear: 'شفاف',
          tpu: 'ژله‌ای',
          plastic: 'پلاستیکی',
          metal: 'فلزی',
          nylon: 'نایلون',
          hard: 'سخت'
        },
        type: {
          adapter: 'آداپتور',
          cable: 'کابل',
          popsocket: 'پاپ سوکت',
          holder: 'هولدر',
          privacy: 'پرایوسی',
          ceramic: 'سرامیکی',
          standard: 'معمولی'
        },
        watt: {
          '20w': '۲۰ وات',
          '30w': '۳۰ وات',
          '33w': '۳۳ وات',
          '65w': '۶۵ وات'
        },
        port: {
          'usb-c': 'USB-C',
          'usb-a': 'USB-A',
          'usb-c+usb-a': 'USB-C + USB-A'
        },
        storage: {
          '128': '۱۲۸ گیگ',
          '256': '۲۵۶ گیگ',
          '512': '۵۱۲ گیگ'
        },
        ram: {
          '8': '۸ گیگ',
          '12': '۱۲ گیگ',
          '16': '۱۶ گیگ'
        }
      };

      const normalize = (value) => String(value || '').trim().toLowerCase();

      const getCardsForCategory = (category) => {
        if (category === 'all') return productCards;
        if (category === 'accessory') {
          // "اکسسوری" یعنی همه‌ی محصولات به‌جز گوشی هوشمند
          return productCards.filter((card) => (card.dataset.category || '') !== 'phone');
        }
        return productCards.filter((card) => card.dataset.category === category);
      };

      const getLabel = (key, value) => {
        const map = FILTER_LABELS[key];
        return map && map[value] ? map[value] : value;
      };

      const getCardValues = (card, key) => {
        const raw = card?.dataset?.[key];
        if (!raw) return [];
        return raw.split(/[|,]/).map((val) => normalize(val));
      };

      const getGroupValues = (category, group) => {
        const valuesMap = new Map();
        const cards = getCardsForCategory(category);

        cards.forEach((card) => {
          const raw = card.dataset[group.key];
          if (!raw) return;
          raw.split(/[|,]/).forEach((val) => {
            const trimmed = val.trim();
            if (!trimmed) return;
            const normalized = normalize(trimmed);
            if (!valuesMap.has(normalized)) valuesMap.set(normalized, trimmed);
          });
        });

        if (valuesMap.size === 0 && Array.isArray(group.options)) {
          group.options.forEach((opt) => {
            const normalized = normalize(opt);
            if (!valuesMap.has(normalized)) valuesMap.set(normalized, opt);
          });
        }

        return Array.from(valuesMap.values());
      };

      const currentFilters = {
        category: 'all',
        attributes: {},
        inStock: false,
        search: ''
      };

      const setActiveCategory = (cat) => {
        const normalized = CATEGORY_ALIASES[cat] || cat || 'all';
        categoryButtons.forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.category === normalized);
        });
        currentFilters.category = normalized;
        updateActiveCategoryLabel();
      };

      const renderDynamicFilters = () => {
        if (!dynamicFiltersEl) return;
        dynamicFiltersEl.innerHTML = '';
        const groups = FILTER_GROUPS[currentFilters.category] || FILTER_GROUPS.all;
        let hasAnyOptions = false;

        groups.forEach((group) => {
          const values = getGroupValues(currentFilters.category, group);
          const details = document.createElement('details');
          details.className = 'filter-subgroup';
          details.open = true;

          const summary = document.createElement('summary');
          summary.className = 'filter-subgroup-summary';
          const summaryText = document.createElement('span');
          summaryText.textContent = group.label;
          const summaryIcon = document.createElement('span');
          summaryIcon.className = 'material-icon';
          summaryIcon.textContent = 'expand_more';
          summary.append(summaryText, summaryIcon);
          details.appendChild(summary);

          const optionsWrap = document.createElement('div');
          optionsWrap.className = 'filter-options';

          if (values.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'filter-group-empty';
            empty.textContent = 'فعلا گزینه‌ای برای این فیلتر ثبت نشده است.';
            optionsWrap.appendChild(empty);
          } else {
            hasAnyOptions = true;
            values.forEach((rawValue) => {
              const normalized = normalize(rawValue);
              const label = getLabel(group.key, rawValue);
              const labelEl = document.createElement('label');
              labelEl.className = 'filter-option';

              const input = document.createElement('input');
              input.type = 'checkbox';
              input.className = 'filter-input';
              input.value = rawValue;
              input.dataset.filterKey = group.key;
              input.dataset.normalized = normalized;

              const span = document.createElement('span');
              span.textContent = label;

              labelEl.append(input, span);
              optionsWrap.appendChild(labelEl);
            });
          }

          details.appendChild(optionsWrap);
          dynamicFiltersEl.appendChild(details);
        });

        if (dynamicFiltersEmptyEl) {
          dynamicFiltersEmptyEl.classList.toggle('hidden', hasAnyOptions);
        }

        const inputs = dynamicFiltersEl.querySelectorAll('input.filter-input');
        inputs.forEach((input) => {
          input.addEventListener('change', () => {
            const label = input.closest('label');
            if (label) label.classList.toggle('selected', input.checked);
            filterAndSortProducts();
          });
        });
      };

      const collectFiltersFromUI = () => {
        const activeCategoryBtn = document.querySelector('.category-filter-btn.active');
        currentFilters.category = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'all';
        currentFilters.inStock = Boolean(inStockToggle && inStockToggle.checked);
        currentFilters.search = filterSearch ? normalize(filterSearch.value) : '';
        currentFilters.attributes = {};

        if (dynamicFiltersEl) {
          dynamicFiltersEl.querySelectorAll('input.filter-input:checked').forEach((input) => {
            const key = input.dataset.filterKey;
            const normalized = input.dataset.normalized || normalize(input.value);
            if (!currentFilters.attributes[key]) currentFilters.attributes[key] = [];
            currentFilters.attributes[key].push(normalized);
          });
        }
      };

      const updateSelectedFiltersUI = () => {
        if (!selectedFiltersEl) return;
        const chips = [];

        const activeCategoryBtn = document.querySelector('.category-filter-btn.active');
        if (activeCategoryBtn && activeCategoryBtn.dataset.category !== 'all') {
          const label = activeCategoryBtn.querySelector('.category-label')?.textContent?.trim()
            || activeCategoryBtn.textContent.trim();
          chips.push({
            type: 'category',
            label,
            value: activeCategoryBtn.dataset.category
          });
        }

        if (dynamicFiltersEl) {
          dynamicFiltersEl.querySelectorAll('input.filter-input:checked').forEach((input) => {
            const key = input.dataset.filterKey;
            const normalized = input.dataset.normalized || normalize(input.value);
            const label = input.closest('label')?.querySelector('.filter-option-label')?.textContent?.trim() || input.value;
            chips.push({
              type: 'attribute',
              key,
              normalized,
              label
            });
          });
        }

        if (currentFilters.inStock) {
          chips.push({ type: 'stock', label: 'فقط کالاهای موجود' });
        }

        const searchLabel = filterSearch?.value?.trim();
        if (searchLabel) {
          chips.push({ type: 'search', label: `جستجو: ${searchLabel}` });
        }

        selectedFiltersEl.innerHTML = '';
        if (chips.length === 0) {
          selectedFiltersEl.style.display = 'none';
          return;
        }

        selectedFiltersEl.style.display = '';
        chips.forEach((chip) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'filter-chip';
          btn.textContent = chip.label;
          btn.addEventListener('click', () => {
            if (chip.type === 'category') {
              setActiveCategory('all');
              renderDynamicFilters();
            } else if (chip.type === 'attribute' && dynamicFiltersEl) {
              const target = dynamicFiltersEl.querySelector(
                `input.filter-input[data-filter-key="${chip.key}"][data-normalized="${chip.normalized}"]`
              );
              if (target) {
                target.checked = false;
                target.closest('label')?.classList.remove('selected');
              }
            } else if (chip.type === 'stock' && inStockToggle) {
              inStockToggle.checked = false;
            } else if (chip.type === 'search' && filterSearch) {
              filterSearch.value = '';
            }
            filterAndSortProducts();
          });
          selectedFiltersEl.appendChild(btn);
        });
      };

      const buildSearchText = (card) => {
        const title = card.querySelector('h3')?.textContent || '';
        const brand = card.dataset.brand || '';
        const model = card.dataset.model || '';
        const material = card.dataset.material || '';
        const type = card.dataset.type || '';
        const watt = card.dataset.watt || '';
        const port = card.dataset.port || '';
        const searchParts = [
          title,
          brand,
          getLabel('brand', brand),
          model,
          getLabel('material', material),
          getLabel('type', type),
          getLabel('watt', watt),
          getLabel('port', port)
        ];
        return normalize(searchParts.join(' '));
      };

      const filterAndSortProducts = () => {
        collectFiltersFromUI();

        const visibleProducts = [];
        productCards.forEach((card) => {
          const categoryMatch = currentFilters.category === 'all'
            || (currentFilters.category === 'accessory'
              ? (card.dataset.category || '') !== 'phone'
              : card.dataset.category === currentFilters.category);
          const attributesMatch = Object.entries(currentFilters.attributes).every(([key, values]) => {
            if (!values || values.length === 0) return true;
            const cardValues = getCardValues(card, key);
            if (cardValues.length === 0) return false;
            return values.some((val) => cardValues.includes(val));
          });
          const stockMatch = !currentFilters.inStock || card.dataset.stock === 'true';
          const searchMatch = !currentFilters.search || buildSearchText(card).includes(currentFilters.search);
          const isVisible = categoryMatch && attributesMatch && stockMatch && searchMatch;
          card.classList.toggle('hidden', !isVisible);
          if (isVisible) visibleProducts.push(card);
        });

        const sortBy = sortSelect ? sortSelect.value : 'newest';
        visibleProducts.sort((a, b) => {
          switch (sortBy) {
            case 'price-asc':
              return (parseInt(a.dataset.price, 10) || 0) - (parseInt(b.dataset.price, 10) || 0);
            case 'price-desc':
              return (parseInt(b.dataset.price, 10) || 0) - (parseInt(a.dataset.price, 10) || 0);
            case 'oldest':
              return (parseInt(a.dataset.new, 10) || 0) - (parseInt(b.dataset.new, 10) || 0);
            case 'newest':
            default:
              return (parseInt(b.dataset.new, 10) || 0) - (parseInt(a.dataset.new, 10) || 0);
          }
        });

        visibleProducts.forEach((card) => productsGrid.appendChild(card));        if (noResultsEl) {
          noResultsEl.classList.toggle('hidden', visibleProducts.length > 0);
        }

        updateSelectedFiltersUI();
      };

      const updateCategoryInUrl = (category) => {
        try {
          const params = new URLSearchParams(window.location.search);
          if (category === 'all') {
            params.delete('cat');
          } else {
            params.set('cat', category);
          }
          params.delete('category');
          const query = params.toString();
          const newUrl = `${window.location.pathname}${query ? `?${query}` : ''}${window.location.hash}`;
          history.replaceState(null, '', newUrl);
        } catch (e) {}
      };

      if (filterSearch) {
        filterSearch.addEventListener('input', () => filterAndSortProducts());
      }
      if (inStockToggle) {
        inStockToggle.addEventListener('change', () => filterAndSortProducts());
      }
      if (sortSelect) {
        sortSelect.addEventListener('change', () => filterAndSortProducts());
      }

      categoryButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          setActiveCategory(btn.dataset.category);
          renderDynamicFilters();
          updateCategoryInUrl(btn.dataset.category);
          filterAndSortProducts();
        });
      });

      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', () => {
          setActiveCategory('all');
          renderDynamicFilters();
          if (filterSearch) filterSearch.value = '';
          if (inStockToggle) inStockToggle.checked = false;
          if (sortSelect) sortSelect.value = 'newest';
          updateCategoryInUrl('all');
          filterAndSortProducts();
        });
      }
      if (resetFiltersMobileBtn && resetFiltersBtn) {
        resetFiltersMobileBtn.addEventListener('click', () => {
          resetFiltersBtn.click();
        });
      }

      const openFilterMenu = () => {
        if (!filterSidebar || !filterOverlay) return;
        filterSidebar.classList.add('open');
        filterOverlay.classList.add('visible');
        if (mobileFilterBtn) mobileFilterBtn.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
        setTimeout(() => closeFiltersBtn && closeFiltersBtn.focus(), 100);
      };

      const closeFilterMenu = () => {
        if (!filterSidebar || !filterOverlay) return;
        filterSidebar.classList.remove('open');
        filterOverlay.classList.remove('visible');
        if (mobileFilterBtn) mobileFilterBtn.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        if (mobileFilterBtn) mobileFilterBtn.focus();
      };

      if (mobileFilterBtn) mobileFilterBtn.addEventListener('click', openFilterMenu);
      if (closeFiltersBtn) closeFiltersBtn.addEventListener('click', closeFilterMenu);
      if (filterOverlay) filterOverlay.addEventListener('click', closeFilterMenu);
      if (applyFiltersBtn) applyFiltersBtn.addEventListener('click', () => {
        filterAndSortProducts();
        closeFilterMenu();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && filterSidebar && filterSidebar.classList.contains('open')) {
          closeFilterMenu();
        }
      });

      const applyUrlParams = () => {
        const params = new URLSearchParams(window.location.search);
        const catParam = params.get('category') || params.get('cat');
        if (catParam) {
          setActiveCategory(CATEGORY_ALIASES[catParam] || catParam);
        } else {
          setActiveCategory('all');
        }
      };

      applyUrlParams();
      if (!document.querySelector('.category-filter-btn.active')) {
        setActiveCategory('all');
      }

      renderDynamicFilters();
      filterAndSortProducts();
    });
    </script>

<div data-include="footer"></div>
  <script defer src="../assets/js/layout.js"></script>


  <script defer src="../assets/js/script.js"></script>
</body>
</html>
